#!/bin/bash

PROJECT_NAME=$1
if [ -z "$PROJECT_NAME" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: new-project <–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞>"
  exit 1
fi

TEMPLATE="$HOME/clion-templates/c-cpp-cython-python-universal"
DEST="$HOME/CLionProjects/$PROJECT_NAME"

cp -r "$TEMPLATE" "$DEST"

cd "$DEST" || exit 1

find . -type f -name "CMakeLists.txt.in" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;

find . -type f -name "CMakeLists.txt.in" -exec mv {} $(dirname {})/CMakeLists.txt \;

find . -type f -name ".gitignore.template" -exec mv {} .gitignore \;


LIBRARIES_DIR="lib"
PYBIND11_DIR="$LIBRARIES_DIR/pybind11"
PYBIND11_REPO="https://github.com/pybind/pybind11.git"

echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º git –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞..."
git init

if [ ! -d "$PYBIND11_DIR" ]; then
    echo "üì• –î–æ–±–∞–≤–ª—è–µ–º pybind11 –∫–∞–∫ git submodule –≤ $PYBIND11_DIR..."
    git submodule add -f "$PYBIND11_REPO" "$PYBIND11_DIR"
    
    if [ $? -eq 0 ]; then
        echo "pybind11 —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ submodule"
    else
        echo "–ü–æ–¥–º–æ–¥—É–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)"
    fi
else
    echo "–ü–∞–ø–∫–∞ $PYBIND11_DIR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
fi

git config core.fileMode false


git add .
git commit -m "Initial commit from template with pybind11 submodule"

echo "–ü—Ä–æ–µ–∫—Ç '$PROJECT_NAME' —Å–æ–∑–¥–∞–Ω –≤ $DEST"
echo "–û—Ç–∫—Ä–æ–π –µ–≥–æ –≤ CLion. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–±–æ—Ä–∫–∏ ‚Äî submodule –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤."
echo "–ï—Å–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—à—å –ø—Ä–æ–µ–∫—Ç: git clone --recurse-submodules ..."