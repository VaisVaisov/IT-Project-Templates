#!/bin/bash

PROJECT_NAME=$1
if [ -z "$PROJECT_NAME" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: new-project <–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞>"
  exit 1
fi

TEMPLATE="$HOME/clion-templates/c-cpp-cython-python-universal"
DEST="$HOME/CLionProjects/$PROJECT_NAME"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
if [ ! -d "$TEMPLATE" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: $TEMPLATE"
  exit 1
fi

# –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç
cp -r "$TEMPLATE" "$DEST"
cd "$DEST" || exit 1

echo "üìÅ –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç: $PROJECT_NAME"

# –ó–∞–º–µ–Ω–∞ @PROJECT_NAME@ –≤ —Ñ–∞–π–ª–∞—Ö
find . -type f -name "CMakeLists.txt.in" -exec sed -i "s|@PROJECT_NAME@|$PROJECT_NAME|g" {} \;
find . -type f -name "CMakeLists.txt.in" -exec mv {} $(dirname {})/CMakeLists.txt \;

find . -type f -name "Doxyfile.in" -exec sed -i "s|@PROJECT_NAME@|$PROJECT_NAME|g" {} \;
find . -type f -name "Doxyfile.in" -exec mv {} $(dirname {})/Doxyfile \;

find . -type f -name "conf.py.in" -exec sed -i "s|@PROJECT_NAME@|$PROJECT_NAME|g" {} \;
find . -type f -name "conf.py.in" -exec mv {} $(dirname {})/conf.py \;

find . -type f -name "index.rst" -exec sed -i "s|@PROJECT_NAME@|$PROJECT_NAME|g" {} \;

# .gitignore
find . -type f -name ".gitignore.template" -exec mv {} .gitignore \;

# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "‚úÖ –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv..."
python3 -m venv .venv || { echo "‚ùå –û—à–∏–±–∫–∞: python3-venv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }

source .venv/bin/activate
python -m pip install --upgrade pip

if [ -f "requirements.txt" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install -r requirements.txt
else
    echo "‚ÑπÔ∏è  requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É"
fi

# Docker –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
if [ ! "$(docker images -q docs-builder 2>/dev/null)" ]; then
    echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ docs-builder..."
    docker build -f Dockerfile.docs -t docs-builder .
fi

echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker-–æ–±—Ä–∞–∑ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è C/C++..."
if [ ! "$(docker images -q profiler-tool 2>/dev/null)" ]; then
    echo "$DOCKERFILE_PROFILER" | docker build -f "tools/profiler/Dockerfile" -t profiler-tool -
    if [ $? -eq 0 ]; then
        echo "‚úÖ Docker-–æ–±—Ä–∞–∑ profiler-tool —Å–æ–∑–¥–∞–Ω"
    else
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å profiler-tool (Docker –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
    fi
else
    echo "‚ôªÔ∏è  Docker-–æ–±—Ä–∞–∑ profiler-tool —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# Git
git init
echo "‚ú® –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Git..."

# Git submodule –¥–ª—è googletest
if [ -d "libraries/googletest" ]; then
    echo "üîÅ googletest —É–∂–µ –µ—Å—Ç—å"
else
    git submodule add https://github.com/google/googletest.git libraries/googletest
    echo "‚úÖ googletest –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ submodule"
fi

# –ü–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç
git add .
git commit -m "feat: initial commit from universal template"

echo ""
echo "‚úÖ –ü—Ä–æ–µ–∫—Ç '$PROJECT_NAME' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ $DEST"
echo ""
echo "üí° –î–∞–ª–µ–µ:"
echo "   source .venv/bin/activate"
echo "   mkdir build && cd build"
echo "   cmake .. && make"
echo ""
echo "   # –¢–µ—Å—Ç—ã"
echo "   ctest"
echo "   pytest python/tests/"
echo ""
echo "   # –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo "   scripts/profile-python.sh"
echo "   scripts/profile-cpp.sh –∏–º—è_–±–∏–Ω–∞—Ä–Ω–∏–∫–∞"
echo "   snakeviz profile.prof  # –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è"
echo ""
echo "   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
echo "   docker run --rm -v \$(pwd):/docs docs-builder doxygen docs/cpp/Doxyfile"
echo "   docker run --rm -v \$(pwd):/docs docs-builder make -C docs/python html"
echo ""
echo "‚ú® –£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!"