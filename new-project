#!/bin/bash

set -euo pipefail

# üìÅ –ü—É—Ç–∏
TEMPLATES_DIR="$HOME/IT-Project-Templates"
CLION_PROJECTS="$HOME/CLionProjects"
PYCHARM_PROJECTS="$HOME/PycharmProjects"

# üé® –¶–≤–µ—Ç–∞
GREEN="‚úÖ"
RED="‚ùå"
BLUE="üìÅ"
YELLOW="‚ö†Ô∏è"

# ========================================
# üîß –§—É–Ω–∫—Ü–∏–∏
# ========================================

show_usage() {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞> [—Ñ–ª–∞–≥–∏]"
    echo ""
    echo "–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏:"
    echo "  --clion            –°–æ–∑–¥–∞—Ç—å –≤ CLionProjects"
    echo "  --pycharm          –°–æ–∑–¥–∞—Ç—å –≤ PycharmProjects"
    echo ""
    echo "–¢–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–æ–≤:"
    echo "  --pure-c-cpp       –ß–∏—Å—Ç—ã–π C/C++"
    echo "  --pure-py          –ß–∏—Å—Ç—ã–π Python"
    echo "  --jupyter          Jupyter Notebook + Conda"
    echo "  --hybrid           –ì–∏–±—Ä–∏–¥–Ω—ã–π (Cython + C/C++)"
    echo "  --platformio       Embedded (Arduino, ESP32 –∏ –¥—Ä.)"
    echo ""
    echo "PlatformIO —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:"
    echo "  --arduino-nano"
    echo "  --arduino-pro-micro"
    echo "  --esp32-devkit"
    echo "  --stm32f411"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 my_cpp --clion --pure-c-cpp"
    echo "  $0 ml_notebook --pycharm --jupyter"
    echo "  $0 sensor_node --clion --platformio --esp32-devkit"
    exit 1
}

validate_project_name() {
    local name="$1"
    if [ -z "$name" ]; then
        echo "$RED –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ."
        show_usage
    fi
}

setup_conda_env() {
    local env_name="$1"
    if command -v conda &> /dev/null; then
        echo "$BLUE –°–æ–∑–¥–∞—ë–º Conda-–æ–∫—Ä—É–∂–µ–Ω–∏–µ: $env_name"
        conda create -y -n "$env_name" python=3.11 ipykernel jupyter
        conda run -n "$env_name" python -m ipykernel install --user --name "$env_name" --display-name "Python ($env_name)"
    else
        echo "$RED Conda –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Miniconda –∏–ª–∏ Anaconda."
        exit 1
    fi
}

replace_placeholders() {
    local project_name="$1"
    find . -type f \( -name "*.in" -o -name "*.template" \) -exec sed -i "s|@PROJECT_NAME@|$project_name|g" {} \;
    find . -type f -name "*.in" -exec sh -c 'mv "$1" "$(dirname "$1")/$(basename "$1" .in)"' _ {} \;
    find . -type f -name "*.template" -exec sh -c 'mv "$1" "$(dirname "$1")/$(basename "$1" .template)"' _ {} \;
}
init_git() {
    git init
    echo "$BLUE –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Git..."
    if [ "$CLION" = "true" ] && { [ "$HYBRID" = "true" ] || [ "$PURE_CPP" = "true" ]; }; then
        git submodule add https://github.com/google/googletest.git libraries/googletest
        echo "$GREEN googletest –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ submodule"
    fi

    git add .
    git commit -m "feat: initial commit from template"
}

build_docker_images() {

    if [ -f "Dockerfile.docs" ] && [ -f "docs/cpp/Doxyfile" ] && [ -f "docs/python/conf.py" ]; then
    echo "$BLUE –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ docs-builder..."
      if docker build -f Dockerfile.docs -t docs-builder .; then
        echo "$GREEN –û–±—Ä–∞–∑ docs-builder —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
      else
        echo "$RED –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å docs-builder"
        return 1
      fi
    else
      echo "$YELLOW –í–Ω–∏–º–∞–Ω–∏–µ: Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ docs-builder"
    fi

    if [ -f "tools/profiler/Dockerfile" ]; then
      echo "$BLUE –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ profiler-tool..."
      if docker build -f tools/profiler/Dockerfile -t profiler-tool .; then
        echo "$GREEN –û–±—Ä–∞–∑ profiler-tool —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
      else
        echo "$RED –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å profiler-tool"
        return 1
      fi
    else
      echo "$YELLOW –í–Ω–∏–º–∞–Ω–∏–µ: Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ profiler-tool"
    fi
}
# ========================================
# üöÄ –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
# ========================================

PROJECT_NAME="${1:-}"
shift 2>/dev/null || true

validate_project_name "$PROJECT_NAME"

# –§–ª–∞–≥–∏
CLION=false
PYCHARM=false
PURE_CPP=false
PURE_PY=false
JUPYTER=false
HYBRID=false
PLATFORMIO=false
DEVICE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --clion)
            CLION=true
            shift
            ;;
        --pycharm)
            PYCHARM=true
            shift
            ;;
        --pure-c-cpp)
            PURE_CPP=true
            shift
            ;;
        --pure-py)
            PURE_PY=true
            shift
            ;;
        --jupyter)
            JUPYTER=true
            shift
            ;;
        --hybrid)
            HYBRID=true
            shift
            ;;
        --platformio)
            PLATFORMIO=true
            shift
            ;;
        --arduino-nano)
            DEVICE="arduino-nano"
            shift
            ;;
        --arduino-pro-micro)
            DEVICE="arduino-pro-micro"
            shift
            ;;
        --esp32-devkit)
            DEVICE="esp32-devkit"
            shift
            ;;
        --stm32f411)
            DEVICE="stm32f411"
            shift
            ;;
        -*)
            echo "$RED –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–ª–∞–≥: $1"
            show_usage
            ;;
        *)
            shift
            ;;
    esac
done

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º IDE –∏ —Ç–∏–ø
if $CLION; then
    DEST="$CLION_PROJECTS/$PROJECT_NAME"
    TEMPLATES_DIR="$TEMPLATES_DIR/clion"
elif $PYCHARM; then
    DEST="$PYCHARM_PROJECTS/$PROJECT_NAME"
    TEMPLATES_DIR="$TEMPLATES_DIR/pycharm"
else
    echo "$RED –£–∫–∞–∂–∏—Ç–µ --clion –∏–ª–∏ --pycharm"
    show_usage
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —à–∞–±–ª–æ–Ω
TEMPLATE=""

if $PURE_CPP; then
    TEMPLATE="$TEMPLATES_DIR/pure-c-cpp"
elif $PURE_PY; then
    TEMPLATE="$TEMPLATES_DIR/pure-python"
elif $JUPYTER; then
    TEMPLATE="$TEMPLATES_DIR/jupyter"
elif $HYBRID; then
    TEMPLATE="$TEMPLATES_DIR/hybrid"
elif $PLATFORMIO && [ -n "$DEVICE" ]; then
    TEMPLATE="$TEMPLATES_DIR/platformio/$DEVICE"
elif $PLATFORMIO; then
    echo "$RED –£–∫–∞–∂–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: --arduino-nano, --esp32-devkit –∏ –¥—Ä."
    show_usage
else
    echo "$RED –£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞: --pure-c-cpp, --jupyter, --hybrid, --platformio"
    show_usage
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–±–ª–æ–Ω–∞
if [ ! -d "$TEMPLATE" ]; then
    echo "$RED –®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: $TEMPLATE"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É: $TEMPLATES_DIR"
    exit 1
fi

# –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç
echo "$BLUE –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç: $PROJECT_NAME"
cp -r "$TEMPLATE" "$DEST"
cd "$DEST" || exit 1

# –ó–∞–º–µ–Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
replace_placeholders "$PROJECT_NAME"

# –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if { [ "$CLION" = "true" ] && [ "$HYBRID" = "true" ]; } || { [ "$PYCHARM" = "true" ] && [ "$PURE_PY" = "true" ]; }; then
    echo "$BLUE –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv"
    python -m venv .venv
    source .venv/bin/activate
    pip install --upgrade pip
    if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
    fi
fi

if $JUPYTER; then
    setup_conda_env "$PROJECT_NAME"
fi

# Git
init_git

# Docker (—Ç–æ–ª—å–∫–æ –¥–ª—è CLion)
if [ "$CLION" == "true" ]; then
  build_docker_images
fi


# ========================================
# üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏
# ========================================

echo ""
echo "$GREEN –ü—Ä–æ–µ–∫—Ç '$PROJECT_NAME' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ $DEST"
echo ""

if $CLION; then
    echo "üí° –î–ª—è CLion:"
    echo "   mkdir build && cd build"
    echo "   cmake .."
    echo "   make"
    echo "   ctest"
fi

if $PYCHARM || $JUPYTER || $PURE_PY; then
    echo "üí° –î–ª—è Python:"
    if $JUPYTER; then
        echo "   conda activate $PROJECT_NAME"
        echo "   jupyter lab"
    else
        echo "   source .venv/bin/activate"
        echo "   pytest tests/"
    fi
fi

if $PLATFORMIO; then
    echo "üí° PlatformIO:"
    echo "   platformio run"
    echo "   platformio device list"
fi

echo ""
echo "‚ú® –£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!"
