#!/bin/bash

PROJECT_NAME=$1
if [ -z "$PROJECT_NAME" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: new-project <–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞>"
  exit 1
fi

TEMPLATE="$HOME/clion-templates/c-cpp-cython-python-universal"
DEST="$HOME/CLionProjects/$PROJECT_NAME"

cp -r "$TEMPLATE" "$DEST"

cd "$DEST" || exit 1

find . -type f -name "CMakeLists.txt.in" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;
find . -type f -name "CMakeLists.txt.in" -exec mv {} $(dirname {})/CMakeLists.txt \;

find . -type f -name ".gitignore.template" -exec mv {} .gitignore \;

LIBRARIES_DIR="lib"
PYBIND11_DIR="$LIBRARIES_DIR/pybind11"
PYBIND11_REPO="https://github.com/pybind/pybind11.git"

echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º git –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞..."
git init

if [ ! -d "$PYBIND11_DIR" ]; then
    echo "–î–æ–±–∞–≤–ª—è–µ–º pybind11 –∫–∞–∫ git submodule –≤ $PYBIND11_DIR..."
    git submodule add -f "$PYBIND11_REPO" "$PYBIND11_DIR"
    
    if [ $? -eq 0 ]; then
        echo "pybind11 —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ submodule"
    else
        echo "–ü–æ–¥–º–æ–¥—É–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏"
    fi
else
    echo "üìÅ –ü–∞–ø–∫–∞ $PYBIND11_DIR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
fi

git config core.fileMode false

echo "–°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv..."
python3 -m venv .venv

if [ $? -ne 0 ]; then
    echo "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å .venv. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω python3-venv"
    exit 1
fi

echo "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv —Å–æ–∑–¥–∞–Ω–æ"

echo "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º .venv –∏ –æ–±–Ω–æ–≤–ª—è–µ–º pip..."
source .venv/bin/activate
python -m pip install --upgrade pip

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ pip"
    exit 1
fi

echo "pip –æ–±–Ω–æ–≤–ª—ë–Ω"

echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã: numpy, cython"
pip install numpy cython

if [ $? -eq 0 ]; then
    echo "numpy –∏ cython —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ .venv"
else
    echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ numpy/cython (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é)"
fi

git add .
git commit -m "Initial commit from template with pybind11 submodule and .venv"

echo "–ü—Ä–æ–µ–∫—Ç '$PROJECT_NAME' —Å–æ–∑–¥–∞–Ω –≤ $DEST, –æ—Ç–∫—Ä–æ–π –µ–≥–æ –≤ CLion"