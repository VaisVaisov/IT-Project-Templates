#!/bin/bash

PROJECT_NAME=$1
if [ -z "$PROJECT_NAME" ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: new-project <–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞>"
  exit 1
fi

TEMPLATE="$HOME/clion-templates/c-cpp-cython-python-universal"
DEST="$HOME/CLionProjects/$PROJECT_NAME"

cp -r "$TEMPLATE" "$DEST"
cd "$DEST" || exit 1

find . -type f -name "CMakeLists.txt.in" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;
find . -type f -name "CMakeLists.txt.in" -exec mv {} $(dirname {})/CMakeLists.txt \;

find . -type f -name "Doxyfile.in" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;
find . -type f -name "Doxyfile.in" -exec mv {} $(dirname {})/Doxyfile \;

find . -type f -name "conf.py.in" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;
find . -type f -name "conf.py.in" -exec mv {} $(dirname {})/conf.py \;

find . -type f -name "index.rst" -exec sed -i "s/@PROJECT_NAME@/$PROJECT_NAME/g" {} \;

find . -type f -name ".gitignore.template" -exec mv {} .gitignore \;

echo "‚úÖ –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv..."
python3 -m venv .venv || { echo "‚ùå –û—à–∏–±–∫–∞: python3-venv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }

source .venv/bin/activate
python -m pip install --upgrade pip

if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    echo "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

if [ ! "$(docker images -q docs-builder 2>/dev/null)" ]; then
    echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ docs-builder..."
    docker build -f Dockerfile.doc -t docs-builder .
fi

echo "–ü—Ä–æ–µ–∫—Ç '$PROJECT_NAME' —Å–æ–∑–¥–∞–Ω –≤ $DEST"
echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:"
echo "   docker run --rm -v \$(pwd):/docs docs-builder doxygen docs/cpp/Doxyfile"
echo "   docker run --rm -v \$(pwd):/docs docs-builder make -C docs/python html"
echo "–°–æ–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç: mkdir build && cd build && cmake .. && make"