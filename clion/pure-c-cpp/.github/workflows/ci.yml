name: CI Pipeline

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        sudo pacman -Syu
        sudo pacman -S -y python3-pip build-essential cmake libgtest-dev doxygen
        pip install --upgrade pip

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        pip install pytest sphinx sphinx-rtd-theme

    - name: –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
      run: |
        mkdir build && cd build
        cmake ..
        make

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å C++ —Ç–µ—Å—Ç—ã
      run: |
        cd build
        ctest --output-on-failure

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å Python —Ç–µ—Å—Ç—ã
      run: |
        cd build
        cd ../python/tests
        python -m pytest -v

    - name: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å C++ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ Docker
      run: |
        docker run --rm -v ${PWD}:/src -w /src doxygen/doxygen doxygen docs/cpp/Doxyfile

    - name: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Python –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ Docker
      run: |
        docker run --rm -v ${PWD}:/docs -w /docs \
          -e PIP_CACHE_DIR=/tmp/pip-cache \
          python:3.11-slim \
          /bin/bash -c "pip install sphinx sphinx-rtd-theme && cd docs/python && sphinx-apidoc -o . ../../python --force && make html"

    - name: –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (GitHub Pages)
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p docs/_site
        cp -r docs/cpp/generated/html docs/_site/cpp
        cp -r docs/python/_build/html docs/_site/python
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/_site
        git commit -m "üìñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" || exit 0
        git subtree push --prefix docs/_site origin gh-pages