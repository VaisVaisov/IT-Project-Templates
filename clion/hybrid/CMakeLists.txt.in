cmake_minimum_required(VERSION 3.24)
project(@PROJECT_NAME@ LANGUAGES C CXX)

# –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/lib)

# –ü–æ–∏—Å–∫ Python
find_package(Python3 REQUIRED COMPONENTS Interpreter)

# –ü—É—Ç—å –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é
if(EXISTS ${CMAKE_SOURCE_DIR}/.venv/bin/python)
    set(PYTHON_EXECUTABLE ${CMAKE_SOURCE_DIR}/.venv/bin/python)
else()
    set(PYTHON_EXECUTABLE Python3_EXECUTABLE)
endif()

# –ü—É—Ç–∏ –∫ Cython
set(SETUP_PY ${CMAKE_SOURCE_DIR}/cython/setup.py)
set(CYTHON_BUILD_DIR ${CMAKE_SOURCE_DIR}/cython/build)

# –¶–µ–ª—å: —Å–±–æ—Ä–∫–∞ Cython-–º–æ–¥—É–ª—è
if(EXISTS ${SETUP_PY})
    add_custom_target(
        build_cython ALL
        COMMAND ${PYTHON_EXECUTABLE} ${SETUP_PY} build_ext --inplace
        WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/cython
        COMMENT "üõ†Ô∏è Building Cython module..."
        VERBATIM
    )
else()
    message(WARNING "setup.py not found in cython/ ‚Äî skipping Cython build")
endif()

# –¶–µ–ª—å: –æ—á–∏—Å—Ç–∫–∞ Cython
add_custom_target(
    clean_cython
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CYTHON_BUILD_DIR}
    COMMAND ${CMAKE_COMMAND} -E remove -f ${CMAKE_SOURCE_DIR}/bin/wrapper*
    COMMENT "üßπ Cleaning Cython build files..."
)

# –í–∫–ª—é—á–∞–µ–º —Ç–µ—Å—Ç—ã
enable_testing()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º googletest
if(EXISTS ${CMAKE_SOURCE_DIR}/libraries/googletest)
    add_subdirectory(libraries/googletest)
else()
    include(FetchContent)
    FetchContent_Declare(
        googletest
        URL https://github.com/google/googletest/archive/refs/tags/v1.14.0.zip
    )
    set(gtest_force_shared_crt ON CACHE BOOL "Always use msvcrt.dll" FORCE)
    FetchContent_MakeAvailable(googletest)
endif()

# –ü—Ä–∏–º–µ—Ä C-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏
if(EXISTS ${CMAKE_SOURCE_DIR}/src/example_c/example_c.c)
    add_library(example_c SHARED src/example_c/example_c.c)
    target_include_directories(example_c PUBLIC include/example_c)
endif()

# –ü—Ä–∏–º–µ—Ä C++-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏
if(EXISTS ${CMAKE_SOURCE_DIR}/src/example_lib/example_lib.cpp)
    add_library(example_lib SHARED src/example_lib/example_lib.cpp)
    target_include_directories(example_lib PUBLIC src/example_lib)
endif()

# –¢–µ—Å—Ç C++
if(EXISTS ${CMAKE_SOURCE_DIR}/test/test_calculator.cpp)
    add_executable(test_calculator test/test_calculator.cpp)
    target_link_libraries(test_calculator GTest::gtest_main example_lib)
    add_test(NAME test_calculator COMMAND test_calculator)
endif()

# –¢–µ—Å—Ç C
if(EXISTS ${CMAKE_SOURCE_DIR}/test/test_math.c)
    add_executable(test_math test/test_math.c)
    target_link_libraries(test_math GTest::gtest_main example_c)
    add_test(NAME test_math COMMAND test_math)
endif()